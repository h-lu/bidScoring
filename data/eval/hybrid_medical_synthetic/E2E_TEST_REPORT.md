# 端到端检索测试报告

## 测试概述

**测试时间**: 2026-02-08  
**数据集**: `hybrid_medical_synthetic` (医疗器械投标文档合成评测集)  
**测试范围**: 从数据导入 → 分层节点构建 → 混合检索评估的完整流程

---

## 数据集信息

| 场景 | 供应商名称 | Version ID | Chunks | Hierarchical Nodes | Qrels |
|------|-----------|------------|--------|-------------------|-------|
| A | 上海澄研医疗科技有限公司 | 33333333-3333-3333-3333-333333333333 | 1,007 | 1,460 | 45 |
| B | 苏州启衡生物仪器有限公司 | 44444444-4444-4444-4444-444444444444 | 1,007 | 1,460 | 45 |
| C | 杭州赛泓精密医疗设备有限公司 | 55555555-5555-5555-5555-555555555555 | 1,007 | 1,460 | 45 |

**查询数量**: 22 个共享查询  
**相关标准**: 3=主证据, 2=支持证据, 1=弱相关, 0=干扰项

---

## 评估指标说明

- **MRR** (Mean Reciprocal Rank): 平均倒数排名，衡量首个相关结果的排名
- **Recall@5**: Top-5 结果中的相关文档召回率
- **Precision@3**: Top-3 结果的精确率
- **nDCG@5/10**: 归一化折损累积增益，衡量排序质量
- **Latency**: 平均检索延迟 (毫秒)

---

## 测试结果

### 各场景详细结果

#### Scenario A - 上海澄研医疗科技有限公司

| 方法 | MRR | Recall@5 | Precision@3 | nDCG@5 | nDCG@10 | Latency |
|------|-----|----------|-------------|--------|---------|---------|
| Vector | 0.8258 | 0.8864 | 0.3636 | 0.7829 | 0.7959 | 849.29ms |
| Keyword | 0.9602 | 0.8409 | 0.4091 | 0.8646 | 0.8793 | 5.72ms |
| **Hybrid** | **0.9697** | **0.8864** | **0.4242** | **0.8841** | **0.8925** | 40.16ms |

#### Scenario B - 苏州启衡生物仪器有限公司

| 方法 | MRR | Recall@5 | Precision@3 | nDCG@5 | nDCG@10 | Latency |
|------|-----|----------|-------------|--------|---------|---------|
| Vector | 0.8447 | 0.8864 | 0.3485 | 0.7964 | 0.8083 | 29.53ms |
| Keyword | 0.9773 | 0.8864 | 0.4242 | 0.8902 | 0.8918 | 5.30ms |
| **Hybrid** | **0.9773** | **0.8864** | **0.4242** | **0.8891** | **0.8989** | 42.18ms |

#### Scenario C - 杭州赛泓精密医疗设备有限公司

| 方法 | MRR | Recall@5 | Precision@3 | nDCG@5 | nDCG@10 | Latency |
|------|-----|----------|-------------|--------|---------|---------|
| Vector | 0.8333 | 0.8636 | 0.3636 | 0.7864 | 0.7992 | 19.73ms |
| Keyword | 0.8788 | 0.8409 | 0.4091 | 0.8157 | 0.8174 | 3.81ms |
| **Hybrid** | **0.8977** | **0.8636** | **0.4091** | **0.8398** | **0.8478** | 22.36ms |

---

### 跨场景宏平均 (Macro-average)

| 方法 | MRR | Recall@5 | Precision@3 | nDCG@5 | nDCG@10 | Latency |
|------|-----|----------|-------------|--------|---------|---------|
| Vector | 0.8346 | 0.8788 | 0.3586 | 0.7886 | 0.8011 | 299.52ms |
| Keyword | 0.9388 | 0.8561 | 0.4141 | 0.8568 | 0.8628 | 4.95ms |
| **Hybrid** | **0.9482** | **0.8788** | **0.4192** | **0.8710** | **0.8797** | 34.90ms |

---

## 关键发现

### 1. 混合检索优势显著
- **Hybrid** 在 MRR (0.9482) 上优于纯 Vector (0.8346) 和 Keyword (0.9388)
- **Hybrid** 的 nDCG@5 (0.8710) 显著高于 Vector (0.7886)
- **Hybrid** 达到了最佳的综合性能

### 2. 关键词检索速度快
- **Keyword** 检索延迟仅 4.95ms，是最快的方法
- **Vector** 检索延迟 299.52ms，主要是向量计算开销
- **Hybrid** 延迟 34.90ms，在可接受范围内

### 3. 场景 C 表现稍弱
- Scenario C 的各项指标略低于 A 和 B
- 可能原因是文档结构或内容差异

### 4. 高召回率
- 所有方法的 Recall@5 都在 85% 以上
- Hybrid 方法达到了 87.88% 的召回率

---

## 测试覆盖的查询类型

本次评估覆盖了以下查询类型：

| 查询类型 | 示例 | 数量 |
|---------|------|------|
| keyword_critical | 售后响应时间、质保期 | 7 |
| factual | 培训对象、业绩数量 | 6 |
| semantic | 备件保障、交付验收 | 3 |
| numeric_reasoning | 培训时长、业绩统计 | 2 |
| conflict_resolution | 交货期冲突、质保别名 | 2 |
| negation | 第三方升级是否包含 | 1 |
| bilingual | 中英混合查询 | 1 |

---

## 技术栈验证

✅ **数据导入**: `bid_scoring.ingest.ingest_content_list`  
✅ **分层节点**: `HiChunkBuilder` + `hierarchical_nodes` 表  
✅ **向量检索**: `pgvector` + `HNSW` 索引  
✅ **关键词检索**: PostgreSQL `tsvector` + `websearch_to_tsquery`  
✅ **混合融合**: `RRF` (Reciprocal Rank Fusion)  
✅ **证据追踪**: `content_units` + `chunk_unit_spans`  

---

## 结论

1. **数据导入**: A/B/C 三个版本的 1,007 chunks 和 1,460 分层节点成功导入
2. **检索性能**: 混合检索在 MRR 和 nDCG 上表现最佳，达到生产可用水平
3. **响应延迟**: Hybrid 模式 34.90ms 的平均延迟满足实时检索需求
4. **系统稳定性**: 完整流程端到端运行稳定，无错误

---

## 脚本使用

```bash
# 运行完整测试流程
uv run python scripts/eval_e2e_full_pipeline.py

# 仅运行评估 (跳过导入和节点构建)
uv run python scripts/eval_e2e_full_pipeline.py --skip-ingest --skip-hichunk

# 输出详细报告
uv run python scripts/eval_e2e_full_pipeline.py --output report.json
```

---

*报告生成时间: 2026-02-08*  
*测试脚本: `scripts/eval_e2e_full_pipeline.py`*
