from __future__ import annotations

from typing import Any


def build_queries(version_tag: str = "multi_scenario_shared") -> list[dict[str, Any]]:
    rows = [
        (
            "Q01",
            "售后响应时间和到场时间分别是多少？",
            ["售后", "响应", "到场", "小时"],
            "keyword_critical",
            "定位核心SLA承诺",
            "2小时响应，24小时到场",
            ["conflict_clause", "unit_normalization"],
        ),
        (
            "Q02",
            "项目免费质保期多久？",
            ["质保", "保修", "月", "年"],
            "keyword_critical",
            "定位质保主承诺",
            "5年（60个月），以验收合格日起算",
            ["alias_term", "numeric_normalization"],
        ),
        (
            "Q03",
            "是否承诺开机率95%以上？",
            ["开机率", "95%", "质保"],
            "factual",
            "识别硬指标承诺",
            "是，承诺不低于95%",
            ["numeric_threshold"],
        ),
        (
            "Q04",
            "备件保障是怎么写的？",
            ["备件", "库存", "易损件"],
            "semantic",
            "检索备件保障策略",
            "上海备件仓+关键备件安全库存",
            ["table_evidence", "semantic_paraphrase"],
        ),
        (
            "Q05",
            "如果72小时修不好，是否提供备用机？",
            ["72小时", "备用机", "修复"],
            "keyword_critical",
            "检索补偿性服务承诺",
            "提供同等级备用机",
            ["condition_clause"],
        ),
        (
            "Q06",
            "第三方软件升级是否包含在免费服务里？",
            ["第三方", "软件", "升级", "免费"],
            "negation",
            "识别否定条款",
            "不包含第三方插件授权升级费用",
            ["negation"],
        ),
        (
            "Q07",
            "培训总共安排几天？",
            ["培训", "第1天", "第2天"],
            "numeric_reasoning",
            "识别培训时长",
            "2天（第1天+第2天）",
            ["table_evidence", "numeric_reasoning"],
        ),
        (
            "Q08",
            "培训对象包括哪些角色？",
            ["培训对象", "使用人员", "维护"],
            "factual",
            "识别培训覆盖人群",
            "使用人员、管理员、维护人员",
            ["list_evidence"],
        ),
        (
            "Q09",
            "交货期承诺是30天还是3个月？",
            ["交货期", "30天", "3个月"],
            "conflict_resolution",
            "区分投标承诺与模板条款",
            "投标响应主承诺为3个月；30天为模板条款",
            ["conflict_clause", "template_vs_commitment"],
        ),
        (
            "Q10",
            "什么情况下算完成交付验收？",
            ["验收", "交付", "安装调试", "验收合格单"],
            "semantic",
            "检索验收完成条件",
            "安装调试后双方签署验收合格单",
            ["cross_section"],
        ),
        (
            "Q11",
            "付款节点怎么约定的？",
            ["预付款", "尾款", "验收"],
            "factual",
            "定位付款比例",
            "30%预付款、60%验收后、10%尾款",
            ["table_evidence"],
        ),
        (
            "Q12",
            "这个设备是否按医疗器械管理，注册证号是什么？",
            ["医疗器械", "注册证", "备案号"],
            "keyword_critical",
            "定位合规属性",
            "标注为不按医疗器械管理，注册证号为/",
            ["table_evidence", "consistency_check"],
        ),
        (
            "Q13",
            "有无反商业贿赂或廉洁条款？",
            ["廉洁", "回扣", "商业贿赂"],
            "factual",
            "检索合规风险条款",
            "有，明确禁止回扣和商业贿赂",
            ["compliance"],
        ),
        (
            "Q14",
            "近三年有几家类似医院项目业绩？",
            ["类似项目", "医院", "2024", "2023", "2022"],
            "numeric_reasoning",
            "统计业绩数量",
            "3家",
            ["table_evidence", "counting"],
        ),
        (
            "Q15",
            "售后团队有多少工程师？",
            ["售后工程师", "团队", "高级工程师"],
            "factual",
            "检索人员配置",
            "共6人",
            ["numeric_threshold"],
        ),
        (
            "Q16",
            "是否支持远程诊断？",
            ["远程诊断", "日志", "远程处置"],
            "semantic",
            "识别远程服务能力",
            "支持远程诊断与日志分析",
            ["semantic_paraphrase"],
        ),
        (
            "Q17",
            "SLA first response within 2 hours 是什么承诺？",
            ["SLA", "first response", "2 hours", "on-site"],
            "semantic",
            "中英混合检索能力",
            "2小时响应、24小时到场",
            ["bilingual", "alias_term"],
        ),
        (
            "Q18",
            "扫描件里写的 响 应 时 间 是多少？",
            ["响 应", "到 场", "2 小 时"],
            "keyword_critical",
            "OCR噪声鲁棒性",
            "2小时响应，24小时到场",
            ["ocr_noise"],
        ),
        (
            "Q19",
            "保修期是不是60个月？",
            ["保修期", "60个月", "质保"],
            "conflict_resolution",
            "同义词与多来源一致性",
            "主承诺5年/60个月，与制造商承诺一致",
            ["alias_term", "conflict_clause"],
        ),
        (
            "Q20",
            "制造商上门时效写的是多久？",
            ["制造商", "上门", "工作日"],
            "factual",
            "区分供应商与制造商措辞",
            "2个工作日内上门",
            ["conflict_clause"],
        ),
        (
            "Q21",
            "质保期外备件价格有没有上限约束？",
            ["质保期外", "备件", "市场价", "上限"],
            "factual",
            "检索价格约束条款",
            "不高于市场同期均价",
            ["pricing_clause"],
        ),
        (
            "Q22",
            "评分索引里售后和培训分别在第几页？",
            ["评分", "索引", "售后", "培训", "页"],
            "keyword_critical",
            "检索索引定位信息",
            "售后16-19页，培训20-22页",
            ["table_evidence", "cross_section"],
        ),
    ]

    return [
        {
            "query_id": qid,
            "version_tag": version_tag,
            "query": query,
            "keywords": kw,
            "query_type": qtype,
            "intent": intent,
            "expected_answer": ans,
            "edge_focus": edge,
        }
        for qid, query, kw, qtype, intent, ans, edge in rows
    ]


def build_qrels(
    *,
    anchors: dict[str, int],
    content: list[dict[str, Any]],
    version_tag: str,
) -> list[dict[str, Any]]:
    specs = [
        (
            "Q01",
            "service_response_2h_24h",
            3,
            "主承诺中明确2小时响应+24小时到场",
            ["conflict_clause", "unit_normalization"],
        ),
        ("Q01", "ocr_response_clause", 2, "OCR噪声文本复述了同一时效", ["ocr_noise"]),
        (
            "Q01",
            "manufacturer_response_2workdays",
            1,
            "存在冲突的次级来源，时效更弱",
            ["conflict_clause", "template_vs_commitment"],
        ),
        ("Q02", "service_warranty_5y", 3, "供应商主承诺5年质保", ["alias_term", "numeric_normalization"]),
        ("Q02", "warranty_60_month", 2, "制造商承诺60个月，支持主结论", ["numeric_normalization"]),
        (
            "Q02",
            "contract_warranty_36_month",
            1,
            "模板条款36个月，需降权",
            ["template_vs_commitment", "conflict_clause"],
        ),
        ("Q03", "service_uptime_95", 3, "明确给出开机率不低于95%", ["numeric_threshold"]),
        ("Q03", "service_warranty_5y", 1, "同属售后段落但无95%关键数字", ["hard_negative"]),
        ("Q04", "service_spare_parts", 3, "备件仓库与库存策略直接命中", ["semantic_paraphrase"]),
        ("Q04", "parts_price_clause", 2, "补充说明了备件价格约束", ["pricing_clause"]),
        ("Q05", "service_backup_machine", 3, "72小时未恢复提供备用机", ["condition_clause"]),
        ("Q05", "service_response_2h_24h", 2, "同段落上下文支持故障处置链路", ["cross_section"]),
        ("Q06", "service_no_third_party_upgrade", 3, "否定条款：不包含第三方插件升级", ["negation"]),
        ("Q06", "service_warranty_5y", 1, "同主题段落但不回答否定点", ["hard_negative"]),
        ("Q07", "training_schedule_table", 3, "培训计划表可推导总时长2天", ["table_evidence", "numeric_reasoning"]),
        ("Q07", "training_overview", 2, "培训背景信息，可辅助理解", ["semantic_paraphrase"]),
        ("Q08", "training_target", 3, "列表直接枚举培训对象", ["list_evidence"]),
        ("Q08", "training_overview", 1, "说明培训目标但未列人群", ["hard_negative"]),
        ("Q09", "delivery_3months", 3, "投标响应主承诺为3个月", ["conflict_clause", "template_vs_commitment"]),
        ("Q09", "contract_delivery_30days", 2, "模板条款30天，需与主承诺区分", ["conflict_clause"]),
        ("Q10", "acceptance_clause", 3, "交付完成条件定义最直接", ["cross_section"]),
        ("Q10", "delivery_3months", 1, "交付周期相关但不等于验收条件", ["hard_negative"]),
        ("Q11", "payment_terms_table", 3, "付款比例和节点来自表格条款", ["table_evidence"]),
        ("Q11", "acceptance_clause", 1, "验收条件是付款前置但非比例答案", ["cross_section"]),
        ("Q12", "registration_table", 3, "管理属性和注册号信息都在同一条", ["table_evidence", "consistency_check"]),
        ("Q12", "aside_registration_consistency", 2, "边注强调一致性检查重点", ["aside_hint"]),
        ("Q13", "anti_corruption_clause", 3, "廉洁与反商业贿赂条款明确", ["compliance"]),
        ("Q14", "project_experience_table", 3, "三条业绩可直接计数", ["table_evidence", "counting"]),
        ("Q15", "engineer_count_text", 3, "明确给出售后工程师团队数量", ["numeric_threshold"]),
        ("Q15", "project_experience_table", 0, "业绩表不回答人员数量", ["hard_negative"]),
        ("Q16", "remote_diagnosis_clause", 3, "远程诊断与日志分析能力直接命中", ["semantic_paraphrase"]),
        ("Q16", "service_response_2h_24h", 1, "同属服务时效但非远程诊断", ["hard_negative"]),
        ("Q17", "bilingual_sla_clause", 3, "英文SLA表达直接匹配查询语言", ["bilingual"]),
        ("Q17", "service_response_2h_24h", 2, "中文主承诺语义等价", ["alias_term"]),
        ("Q18", "ocr_response_clause", 3, "OCR空格噪声文本需要鲁棒匹配", ["ocr_noise"]),
        ("Q18", "service_response_2h_24h", 2, "标准文本是同一答案的干净版本", ["ocr_noise"]),
        ("Q19", "service_warranty_5y", 3, "质保/保修语义等价的主承诺", ["alias_term", "numeric_normalization"]),
        ("Q19", "warranty_60_month", 2, "60个月别名表达", ["alias_term"]),
        ("Q19", "contract_warranty_36_month", 1, "模板短质保容易误召回", ["conflict_clause"]),
        ("Q20", "manufacturer_response_2workdays", 3, "问题限定制造商条款，答案应是2个工作日", ["conflict_clause"]),
        ("Q20", "service_response_2h_24h", 1, "供应商主承诺不同主体，降权", ["hard_negative"]),
        ("Q21", "parts_price_clause", 3, "质保外价格上限约束直接命中", ["pricing_clause"]),
        ("Q21", "service_spare_parts", 2, "备件保障相关背景", ["cross_section"]),
        ("Q22", "scoring_index_table", 3, "索引表给出售后/培训页码范围", ["table_evidence", "cross_section"]),
        ("Q22", "training_schedule_table", 1, "培训正文不是页码索引答案", ["hard_negative"]),
    ]

    qrels: list[dict[str, Any]] = []
    for query_id, anchor, rel, rationale, edge in specs:
        idx = anchors[anchor]
        qrels.append(
            {
                "query_id": query_id,
                "version_tag": version_tag,
                "source_id": f"chunk_{idx:04d}",
                "relevance": rel,
                "page_idx": int(content[idx]["page_idx"]),
                "evidence_type": str(content[idx]["type"]),
                "rationale": rationale,
                "edge_tags": edge,
            }
        )

    return qrels
