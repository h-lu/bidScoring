from __future__ import annotations

from typing import Any


def build_qrels(
    *,
    anchors: dict[str, int],
    content: list[dict[str, Any]],
    version_tag: str,
) -> list[dict[str, Any]]:
    specs = [
        (
            "Q01",
            "service_response_2h_24h",
            3,
            "主承诺中明确2小时响应+24小时到场",
            ["conflict_clause", "unit_normalization"],
        ),
        ("Q01", "ocr_response_clause", 2, "OCR噪声文本复述了同一时效", ["ocr_noise"]),
        (
            "Q01",
            "manufacturer_response_2workdays",
            1,
            "存在冲突的次级来源，时效更弱",
            ["conflict_clause", "template_vs_commitment"],
        ),
        (
            "Q02",
            "service_warranty_5y",
            3,
            "供应商主承诺5年质保",
            ["alias_term", "numeric_normalization"],
        ),
        (
            "Q02",
            "warranty_60_month",
            2,
            "制造商承诺60个月，支持主结论",
            ["numeric_normalization"],
        ),
        (
            "Q02",
            "contract_warranty_36_month",
            1,
            "模板条款36个月，需降权",
            ["template_vs_commitment", "conflict_clause"],
        ),
        (
            "Q03",
            "service_uptime_95",
            3,
            "明确给出开机率不低于95%",
            ["numeric_threshold"],
        ),
        (
            "Q03",
            "service_warranty_5y",
            1,
            "同属售后段落但无95%关键数字",
            ["hard_negative"],
        ),
        (
            "Q04",
            "service_spare_parts",
            3,
            "备件仓库与库存策略直接命中",
            ["semantic_paraphrase"],
        ),
        ("Q04", "parts_price_clause", 2, "补充说明了备件价格约束", ["pricing_clause"]),
        (
            "Q05",
            "service_backup_machine",
            3,
            "72小时未恢复提供备用机",
            ["condition_clause"],
        ),
        (
            "Q05",
            "service_response_2h_24h",
            2,
            "同段落上下文支持故障处置链路",
            ["cross_section"],
        ),
        (
            "Q06",
            "service_no_third_party_upgrade",
            3,
            "否定条款：不包含第三方插件升级",
            ["negation"],
        ),
        (
            "Q06",
            "service_warranty_5y",
            1,
            "同主题段落但不回答否定点",
            ["hard_negative"],
        ),
        (
            "Q07",
            "training_schedule_table",
            3,
            "培训计划表可推导总时长2天",
            ["table_evidence", "numeric_reasoning"],
        ),
        (
            "Q07",
            "training_overview",
            2,
            "培训背景信息，可辅助理解",
            ["semantic_paraphrase"],
        ),
        ("Q08", "training_target", 3, "列表直接枚举培训对象", ["list_evidence"]),
        ("Q08", "training_overview", 1, "说明培训目标但未列人群", ["hard_negative"]),
        (
            "Q09",
            "delivery_3months",
            3,
            "投标响应主承诺为3个月",
            ["conflict_clause", "template_vs_commitment"],
        ),
        (
            "Q09",
            "contract_delivery_30days",
            2,
            "模板条款30天，需与主承诺区分",
            ["conflict_clause"],
        ),
        ("Q10", "acceptance_clause", 3, "交付完成条件定义最直接", ["cross_section"]),
        (
            "Q10",
            "delivery_3months",
            1,
            "交付周期相关但不等于验收条件",
            ["hard_negative"],
        ),
        (
            "Q11",
            "payment_terms_table",
            3,
            "付款比例和节点来自表格条款",
            ["table_evidence"],
        ),
        (
            "Q11",
            "acceptance_clause",
            1,
            "验收条件是付款前置但非比例答案",
            ["cross_section"],
        ),
        (
            "Q12",
            "registration_table",
            3,
            "管理属性和注册号信息都在同一条",
            ["table_evidence", "consistency_check"],
        ),
        (
            "Q12",
            "aside_registration_consistency",
            2,
            "边注强调一致性检查重点",
            ["aside_hint"],
        ),
        (
            "Q13",
            "anti_corruption_clause",
            3,
            "廉洁与反商业贿赂条款明确",
            ["compliance"],
        ),
        (
            "Q14",
            "project_experience_table",
            3,
            "三条业绩可直接计数",
            ["table_evidence", "counting"],
        ),
        (
            "Q15",
            "engineer_count_text",
            3,
            "明确给出售后工程师团队数量",
            ["numeric_threshold"],
        ),
        (
            "Q15",
            "project_experience_table",
            0,
            "业绩表不回答人员数量",
            ["hard_negative"],
        ),
        (
            "Q16",
            "remote_diagnosis_clause",
            3,
            "远程诊断与日志分析能力直接命中",
            ["semantic_paraphrase"],
        ),
        (
            "Q16",
            "service_response_2h_24h",
            1,
            "同属服务时效但非远程诊断",
            ["hard_negative"],
        ),
        (
            "Q17",
            "bilingual_sla_clause",
            3,
            "英文SLA表达直接匹配查询语言",
            ["bilingual"],
        ),
        ("Q17", "service_response_2h_24h", 2, "中文主承诺语义等价", ["alias_term"]),
        ("Q18", "ocr_response_clause", 3, "OCR空格噪声文本需要鲁棒匹配", ["ocr_noise"]),
        (
            "Q18",
            "service_response_2h_24h",
            2,
            "标准文本是同一答案的干净版本",
            ["ocr_noise"],
        ),
        (
            "Q19",
            "service_warranty_5y",
            3,
            "质保/保修语义等价的主承诺",
            ["alias_term", "numeric_normalization"],
        ),
        ("Q19", "warranty_60_month", 2, "60个月别名表达", ["alias_term"]),
        (
            "Q19",
            "contract_warranty_36_month",
            1,
            "模板短质保容易误召回",
            ["conflict_clause"],
        ),
        (
            "Q20",
            "manufacturer_response_2workdays",
            3,
            "问题限定制造商条款，答案应是2个工作日",
            ["conflict_clause"],
        ),
        (
            "Q20",
            "service_response_2h_24h",
            1,
            "供应商主承诺不同主体，降权",
            ["hard_negative"],
        ),
        (
            "Q21",
            "parts_price_clause",
            3,
            "质保外价格上限约束直接命中",
            ["pricing_clause"],
        ),
        ("Q21", "service_spare_parts", 2, "备件保障相关背景", ["cross_section"]),
        (
            "Q22",
            "scoring_index_table",
            3,
            "索引表给出售后/培训页码范围",
            ["table_evidence", "cross_section"],
        ),
        (
            "Q22",
            "training_schedule_table",
            1,
            "培训正文不是页码索引答案",
            ["hard_negative"],
        ),
    ]

    qrels: list[dict[str, Any]] = []
    for query_id, anchor, rel, rationale, edge in specs:
        idx = anchors[anchor]
        qrels.append(
            {
                "query_id": query_id,
                "version_tag": version_tag,
                "source_id": f"chunk_{idx:04d}",
                "relevance": rel,
                "page_idx": int(content[idx]["page_idx"]),
                "evidence_type": str(content[idx]["type"]),
                "rationale": rationale,
                "edge_tags": edge,
            }
        )

    return qrels
